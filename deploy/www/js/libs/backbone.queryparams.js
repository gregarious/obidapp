(function(){function u(e,t){var n=e.split("&");_.each(n,function(e){var n=e.split("=");n.length>1&&n[1]&&t(n[0],n[1])})}var e=/^\?(.*)/,t=/:([\w\d]+)/g,n=/\*([\w\d]+)/g,r=/[-[\]{}()+?.,\\^$|#\s]/g,i=/(\?.*)$/,s=/^([^\?]*)/;Backbone.Router.arrayValueSplit="|";var o=Backbone.History.prototype.getFragment;_.extend(Backbone.History.prototype,{getFragment:function(e,t,n){return e=o.apply(this,arguments),n&&(e=e.replace(i,"")),e},getQueryParameters:function(t,n){t=o.apply(this,arguments);var r=t.replace(s,""),i=r.match(e);if(i){r=i[1];var a={};return u(r,function(e,t){a[e]?_.isString(a[e])?a[e]=[a[e],t]:a[e].push(t):a[e]=t}),a}return{}}}),_.extend(Backbone.Router.prototype,{initialize:function(e){this.encodedSplatParts=e&&e.encodedSplatParts},getFragment:function(e,t,n){return e=o.apply(this,arguments),n&&(e=e.replace(i,"")),e},_routeToRegExp:function(e){var i=n.exec(e)||{index:-1},s=t.exec(e)||{index:-1};e=e.replace(r,"\\$&").replace(t,"([^/?]*)").replace(n,"([^?]*)"),e+="([?]{1}.*)?";var o=new RegExp("^"+e+"$");return i.index>=0&&(s>=0?o.splatMatch=i.index-s.index:o.splatMatch=-1),o},_extractParameters:function(t,n){var r=t.exec(n).slice(1),i=r.length&&r[r.length-1]&&r[r.length-1].match(e);if(i){var s=i[1],o={};if(s){var a=this;u(s,function(e,t){a._setParamValue(e,t,o)})}r[r.length-1]=o}var f=r.length;if(t.splatMatch&&this.encodedSplatParts){if(t.splatMatch<0)return r;f-=1}for(var l=0;l<f;l++)_.isString(r[l])&&(r[l]=decodeURIComponent(r[l]));return r},_setParamValue:function(e,t,n){var r=e.split("."),i=n;for(var s=0;s<r.length;s++){var o=r[s];s===r.length-1?i[o]=this._decodeParamValue(t,i[o]):i=i[o]=i[o]||{}}},_decodeParamValue:function(e,t){var n=Backbone.Router.arrayValueSplit;if(e.indexOf(n)>=0){var r=e.split(n);for(var i=r.length-1;i>=0;i--)r[i]?r[i]=decodeURIComponent(r[i]):r.splice(i,1);return r}return t?_.isArray(t)?(t.push(e),t):[t,e]:decodeURIComponent(e)},toFragment:function(e,t){return t&&(_.isString(t)||(t=this._toQueryString(t)),e+="?"+t),e},_toQueryString:function(e,t){function r(e){return e.replace(n,encodeURIComponent(n))}var n=Backbone.Router.arrayValueSplit;if(!e)return"";t=t||"";var i="";for(var s in e){var o=e[s];if(_.isString(o)||_.isNumber(o)||_.isBoolean(o)||_.isDate(o)){o=this._toQueryParam(o);if(_.isBoolean(o)||o)i+=(i?"&":"")+this._toQueryParamName(s,t)+"="+r(encodeURIComponent(o))}else if(_.isArray(o)){var u="";for(var a in o){var f=this._toQueryParam(o[a]);if(_.isBoolean(f)||f)u+=n+r(f)}u&&(i+=(i?"&":"")+this._toQueryParamName(s,t)+"="+u)}else{var l=this._toQueryString(o,this._toQueryParamName(s,t,!0));l&&(i+=(i?"&":"")+l)}}return i},_toQueryParamName:function(e,t,n){return t+e+(n?".":"")},_toQueryParam:function(e){return _.isNull(e)||_.isUndefined(e)?null:_.isDate(e)?e.getDate().getTime():e}})})()